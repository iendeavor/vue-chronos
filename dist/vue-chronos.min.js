!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).VueChronos=e()}(this,(function(){"use strict";const t=t=>"[object Object]"===Object.prototype.toString.call(t)&&"symbol"!=typeof t,e=e=>t(e)?JSON.parse(JSON.stringify(e)):e,n=(t,e)=>{o({"":t},e)},o=(e,n,i=!0)=>{t(e)&&Object.keys(e).forEach(s=>{t(e[s])&&o(e[s],n,!1),n(e[s],s,e,i)})};const i=(t,e,n,o=".")=>s(t,e,n,o),s=(t,e,n,o=".")=>{try{const i=e.split(o),s=i.pop();return i.forEach(e=>{t=t[e]}),s in t?t[s]:n}catch(t){return n}},r=(t,e,n,o=".")=>a(t,e,n,o),a=(t,e,n,o=".")=>{const i=e.split(o),s=i.pop();i.forEach(e=>{e in t==!1&&(t[e]={}),t=t[e]}),t[s]="function"==typeof n?n():n},c=(o,s,a)=>new o({data:()=>({state:{}}),computed:{userInterface(){const t=e(this.state);return this.addPublicKeys(t),this.addPublicMethods(t),this.deletePrivateKeys(t),t},dependentPaths(){return Array.from(new Set(this.dependentPairPaths.reduce((t,e)=>t.concat(e),[])))},dependentPairPaths(){const t=s.$options[a.optionName];return e=t,"[object Function]"===Object.prototype.toString.call(e)?t.call(s):t;var e},dependentGroupPaths(){const t=i=>{const s=i[i.length-1];o.delete(s);const r=this.dependentPairPaths.filter(([t])=>t===s).map(([t,e])=>e);0===r.length?n.push(e(i)):r.forEach(e=>{t([].concat(i,e))})},n=[],o=new Set(this.dependentPairPaths.map(([t])=>t));for(;0!==o.size;)t([[...o.values()].shift()]);return n}},watch:{dependentPairPaths:{immediate:!0,handler(){this.verify(),this.state=this.genDefaultState()}}},methods:{async load(t,e){await this.$nextTick();const n=this.state,o=this.dependentPairPaths,i=this.dependentGroupPaths;try{this.addCount(n,o,i,t,1),await e}finally{this.addCount(n,o,i,t,-1)}},addCount(t,e,n,o,s){const a=(e=e.filter(([t,e])=>t===o)).map(([t,e])=>e);a.forEach(e=>{const n=i(t,e+=".$receivingCount")+s;r(t,e,n)}),Array.from(new Set(n.filter(t=>t.some(t=>a.includes(t))).reduce((t,e)=>t.concat(e),[]).filter(t=>!1===a.includes(t)))).forEach(e=>{const n=i(t,e+=".$sendingCount")+s;r(t,e,n)})},verify(){const t=t=>{throw t.unshift("\n========== chronos =========="),t.push("=============================\n"),new Error(t.join("\n"))},e=this.dependentPairPaths;"[object Array]"!==Object.prototype.toString.call(e)&&t([`The {${a.optionName}} should be an array, but found:`,`{${e}}`]);const n=e.map(t=>JSON.stringify(t));n.forEach(e=>{n.indexOf(e)!==n.lastIndexOf(e)&&t([`The {${a.optionName}}'s pair should be unique, but found:`,`{${e}}`])}),e.forEach(e=>{"[object Array]"!==Object.prototype.toString.call(e)&&t([`The {${a.optionName}}'s pair should be an array, but found:`,`{${JSON.stringify(e)}}`]),2!==e.length&&t([`The length of {${a.optionName}}'s pair should equals 2, but found:`,`{${JSON.stringify(e)}}`]),e.some(t=>"[object String]"!==Object.prototype.toString.call(t))&&t([`The {${a.optionName}}'s pair should be a string array, but found:`,`{${JSON.stringify(e)}}`])})},genDefaultState(){const t={};return this.dependentPaths.forEach(e=>r(t,e,this.genDefaultLeafState)),t},genDefaultLeafState:()=>({$leaf:!0,$sending:!1,$receiving:!1,$pending:!1,$sendingCount:0,$receivingCount:0}),addPublicKeys(t){n(t,(t,e)=>{if((t=>!1===t.startsWith("$"))(e))if(t.$leaf)t.$sending=0!==t.$sendingCount,t.$receiving=0!==t.$receivingCount,t.$pending=t.$receiving||t.$sending;else{const e=(n=t,Object.keys(n).filter(t=>!1===t.startsWith("$")));t.$sending=e.some(e=>t[e].$sending),t.$receiving=e.some(e=>t[e].$receiving),t.$pending=e.some(e=>t[e].$pending)}var n})},addPublicMethods(t){t.$load=this.load},deletePrivateKeys(e){n(e,e=>{t(e)&&(delete e.$leaf,delete e.$sendingCount,delete e.$receivingCount)})}}}),d=(t,e)=>[e.optionName]in t.$options;return{install:function(t,e){(e=e||{}).getterName=e.getterName||"$chronos",e.optionName=e.optionName||"chronos",t.mixin({data(){return d(this,e)&&(this._chronos=t.observable({instance:{}}),this.$options.computed=this.$options.computed||{},this.$options.computed[e.getterName]=()=>this._chronos&&this._chronos.instance&&this._chronos.instance.userInterface),{}},created(){d(this,e)&&(this._chronos.instance=c(t,this,e))},destroyed(){d(this,e)&&(this._chronos&&this._chronos.instance&&this._chronos.instance.$destroy(),delete this._chronos)}})}}}));
